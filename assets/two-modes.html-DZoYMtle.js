import{_ as n,c as e,o as s,a}from"./app-DtfL_0SO.js";const t={},o=a(`<h1 id="two-modes" tabindex="-1"><a class="header-anchor" href="#two-modes"><span>Two Modes</span></a></h1><h2 id="introduce" tabindex="-1"><a class="header-anchor" href="#introduce"><span>Introduce</span></a></h2><p>In the encryption modes introduced in the previous chapter, there are <code>common</code> and <code>session-key</code>. Let&#39;s start with the conclusion that <code>common</code> is more convenient and <code>session-key</code> is more secure.</p><h2 id="common-mode" tabindex="-1"><a class="header-anchor" href="#common-mode"><span>common mode</span></a></h2><p><code>commom</code> mode, both the front and back ends need to save the same key or key pair for deciphering.(Interface encryption is not limited to the front and back ends, but can also be used to communicate between two servers. Here is an example of the front and back ends.)</p><blockquote><p>Example:</p><ul><li>SecureApi sets the encryption algorithm to <code>AES</code>, generates a key, you can wait for the component to automatically generate or use <code>CipherUtils</code> to generate, or you can use the online website to generate, and then save it in the <code>key</code> field of the <code>SecureApiPropertiesConfig</code>, the front end also saves this key, the front end sends the data encrypted with the key to the back end, and the backend uses the key to decipher after receiving it.</li></ul><p>Disadvantage:</p><ul><li>There is a risk of leakage on the front end of the key (the client end is hacked and debugged by F12)</li><li>The key cannot be dynamically generated, and the front and back ends need to discuss their respective hardcode/hard coding (plaintext keys are more dangerous to transmit in the network than to store in the front end, and services that require interface encryption will never allow you to transmit plaintext keys in the network)</li></ul><p>Advantage:</p><ul><li>Simple implementation, no need to worry about key agreement</li><li>High performance, a copy of the key is kept on the front and back ends, no additional network communication is required to negotiate the key</li></ul></blockquote><h2 id="session-key-mode" tabindex="-1"><a class="header-anchor" href="#session-key-mode"><span>session-key mode</span></a></h2><p>The <code>session-key</code> mode requires both the <code>RSA</code> and <code>symmetric encryption algorithm</code> to cooperate with the implementation. The front end generates a new <code>symmetric encryption key</code> for each request (the key can also be updated every once in a while), and then uses this key to encrypt the data, and then uses the <code>RSA</code> public key to encrypt the key. The encrypted data and key are transmitted to the backend. The backend uses the <code>RSA</code> private key decipher to get the <code>session key</code>. Using the <code>session key</code> decipher data, the return value is relatively simple. Just use the <code>session key</code> to encrypt the return value to the front end. The front end uses <code>session key</code> decipher on it.</p><blockquote><p>Example：</p><ul><li>Backend Use SecureApi to set the encryption mode to <code>session-key</code>, specify the encryption algorithm to <code>RSA</code>, specify the session key encryption algorithm to <code>AES</code>, generate an <code>RSA</code> key pair, saved in the <code>publicKey</code> and <code>privateKey</code> fields of <code>SecureApiPropertiesConfig</code></li><li>The first communication: the front end requests the <code>RSA</code> public key of the back end</li><li>Second communication: The front end uses the backend <code>RSA</code> public key to encrypt any data, and transmits the encrypted data to the backend. The backend uses its own <code>RSA</code> private key decipher. If the decryption is successful, tell the front end that the verification is successful. If the decipher fails, in addition to the code reason, it means that the first communication public key was tampered with during transmission, and the <code>RSA</code> key pair needs to be regenerated for re-verification</li><li>After the verification is successful, the subsequent interface encryption method is: the front end generates a <code>session key</code> for the request, encrypts the data with the <code>session key</code>, and then uses the backend <code>RSA</code> public key to encrypt the <code>session key</code>, and transmits the encrypted data and key to the backend. The backend can write an interception device and save the <code>session key</code> to the <code>key</code> field of the SecureApiPropertiesConfig (no need to decipher by itself). SecureApi will automatically use the <code>RSA</code> private key decipher to get the <code>session key</code>. Subsequent SecureApi will also automatically use the <code>session key</code> decipher and encryption Data</li><li>You can generate a different session key for each request, and you can update the key regularly. The RSA key pair on the backend can also be updated periodically to enhance security</li></ul><p>Disadvantage：</p><ul><li>As you can see, the process is more complicated</li><li>Generating a new key per request and decrypting the key with the <code>RSA</code> private key in the backend will obviously result in more performance loss</li></ul><p>Advantage：</p><ul><li>Safe, safe, and the fuck safe</li></ul></blockquote><p>With the help of SecureApi implementation of the <code>session-key</code> mode, only the following two simple files are required:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="SecureApi config file"><pre class="language-java"><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">SecureApiPropertiesConfig</span> <span class="token function">secureApiPropertiesConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">SecureApiPropertiesConfig</span> secureApiPropertiesConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureApiPropertiesConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// Set mode as session-key</span></span>
<span class="line">    secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span><span class="token class-name">SecureApiProperties<span class="token punctuation">.</span>Mode</span><span class="token punctuation">.</span><span class="token constant">SESSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// Set session key cipher algorithm</span></span>
<span class="line">    secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setSessionKeyCipherAlgorithm</span><span class="token punctuation">(</span><span class="token class-name">CipherAlgorithmEnum</span><span class="token punctuation">.</span><span class="token constant">AES_ECB_PKCS5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// Session-key mode The encryption algorithm must be set to RSA</span></span>
<span class="line">    secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setCipherAlgorithmEnum</span><span class="token punctuation">(</span><span class="token class-name">CipherAlgorithmEnum</span><span class="token punctuation">.</span><span class="token constant">RSA_ECB_SHA256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// The key can not be set, the component will automatically generate one and print it on the console. If you need to generate it manually, you only need to use the CipherUtils provided by the component</span></span>
<span class="line">    <span class="token class-name">CipherUtils</span> cipherUtils <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CipherUtils</span><span class="token punctuation">(</span><span class="token class-name">CipherAlgorithmEnum</span><span class="token punctuation">.</span><span class="token constant">RSA_ECB_SHA256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// The seed parameter can be passed in getRandomRsaKeyPair(&quot;1&quot;), which can be used to control the same key generated each time during testing</span></span>
<span class="line">    <span class="token class-name">RsaKeyPair</span> randomRsaKeyPair <span class="token operator">=</span> cipherUtils<span class="token punctuation">.</span><span class="token function">getRandomRsaKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// Set the generated key pair to secureApiPropertiesConfig</span></span>
<span class="line">    secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setPublicKey</span><span class="token punctuation">(</span>randomRsaKeyPair<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setPrivateKey</span><span class="token punctuation">(</span>randomRsaKeyPair<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> secureApiPropertiesConfig<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In the interception, set the session key of each request to the <code>key</code> value of the <code>secureApiPropertiesConfig</code>, and all subsequent operations are automatically completed by SecureApi.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="SessionKey interceptor"><pre class="language-java"><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecureKeyInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SecureKeyInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecureApiPropertiesConfig</span> secureApiPropertiesConfig<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Here you only need to modify the key value of the secureApiPropertiesConfig in the interception, and the subsequent operations are all done automatically by SecureApi</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SecureApiProperties<span class="token punctuation">.</span>Mode</span><span class="token punctuation">.</span><span class="token constant">SESSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sessionKey <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;sessionKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;session key transmitted from the front: {}&quot;</span><span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            secureApiPropertiesConfig<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13),c=[o];function p(i,l){return s(),e("div",null,c)}const u=n(t,[["render",p],["__file","two-modes.html.vue"]]),d=JSON.parse('{"path":"/en/two-modes.html","title":"Two Modes","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Introduce","slug":"introduce","link":"#introduce","children":[]},{"level":2,"title":"common mode","slug":"common-mode","link":"#common-mode","children":[]},{"level":2,"title":"session-key mode","slug":"session-key-mode","link":"#session-key-mode","children":[]}],"git":{"updatedTime":1721634633000,"contributors":[{"name":"XuYijie","email":"1119461672@qq.com","commits":3}]},"filePathRelative":"en/two-modes.md"}');export{u as comp,d as data};
